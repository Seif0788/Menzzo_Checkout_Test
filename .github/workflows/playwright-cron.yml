name: Playwright Tests & Email Notification

on:
  schedule:
    - cron: '0 */2 * * *' # Run every 2 hours
  workflow_dispatch:      # Manual trigger

jobs:
  test:
    name: Run Playwright Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright Tests
        id: playwright
        run: npx playwright test --project=Global_Checkoutsuite --reporter=line,allure-playwright,json:results.json
        continue-on-error: true

      - name: Generate Allure Report
        run: npm run allure:generate
        if: always()

      - name: Upload Allure Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report
          path: allure-report
          retention-days: 7

      - name: Get Test Results
        if: always()
        id: test-results
        run: |
          if [ -f results.json ]; then
            PASSED=$(jq '.stats.expected' results.json)
            FAILED=$(jq '.stats.unexpected' results.json)
            TOTAL=$(jq '.stats.total' results.json)
            echo "PASSED=$PASSED" >> $GITHUB_ENV
            echo "FAILED=$FAILED" >> $GITHUB_ENV
            echo "TOTAL=$TOTAL" >> $GITHUB_ENV
            
            if [ "$FAILED" -gt 0 ]; then
              echo "STATUS_EMOJI=ðŸ”´ Failure" >> $GITHUB_ENV
            else
              echo "STATUS_EMOJI=ðŸŸ¢ Success" >> $GITHUB_ENV
            fi
          else
            echo "PASSED=0" >> $GITHUB_ENV
            echo "FAILED=0" >> $GITHUB_ENV
            echo "TOTAL=0" >> $GITHUB_ENV
            echo "STATUS_EMOJI=ðŸ”´ Failure (No Results)" >> $GITHUB_ENV
          fi

      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        if: always()
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "${{ env.STATUS_EMOJI }}: Playwright Scheduled Run Finished"
          to: seifeddine.t.axelites@gmail.com
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          body: |
            Playwright Scheduled Run Finished
            
            Date: $(date)
            Status: ${{ env.STATUS_EMOJI }}
            
            Test Statistics:
            - Total: ${{ env.TOTAL }}
            - Passed: ${{ env.PASSED }}
            - Failed: ${{ env.FAILED }}
            
            Download Allure Report: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
